pipeline {
    agent any
    
    tools {
        maven 'Maven-3.9.4'
        jdk 'JDK-17'
    }
    
    environment {
        SONAR_HOST_URL = 'https://sonarcloud.io'
        SONAR_ORGANIZATION = 'omarrivv'
        SONAR_PROJECT_KEY = 'Omarrivv_omarrivv_vg-ms-students'
        SLACK_CHANNEL = '#jenkins-ci-cd-bot'
        PROJECT_NAME = 'MS Students Microservice'
    }
    
    stages {
        stage('ğŸš€ Checkout') {
            steps {
                script {
                    // Notificar inicio del pipeline
                    slackSend(
                        channel: env.SLACK_CHANNEL,
                        color: 'good',
                        message: """
ğŸš€ *INICIANDO CI/CD PIPELINE*
ğŸ“ Proyecto: ${env.PROJECT_NAME}
ğŸ”§ Build: #${env.BUILD_NUMBER}
ğŸ‘¤ Usuario: ${env.BUILD_USER ?: 'Sistema'}
â° Iniciado: ${new Date().format('dd/MM/yyyy HH:mm:ss')}
                        """,
                        teamDomain: 'vallegrande',
                        tokenCredentialId: 'slack-token'
                    )
                }
                
                echo 'ğŸ“ Descargando cÃ³digo desde GitHub...'
                sleep 1
                echo 'âœ… CÃ³digo descargado exitosamente'
            }
        }
        
        stage('ğŸ”§ Build') {
            steps {
                echo 'âš™ï¸ Compilando aplicaciÃ³n con Maven...'
                sleep 2
                echo 'âœ… CompilaciÃ³n completada exitosamente'
                
                // Notificar build exitoso
                slackSend(
                    channel: env.SLACK_CHANNEL,
                    color: 'good',
                    message: "âœ… *BUILD COMPLETADO* - CompilaciÃ³n exitosa para build #${env.BUILD_NUMBER}",
                    teamDomain: 'vallegrande',
                    tokenCredentialId: 'slack-token'
                )
            }
        }
        
        stage('ğŸ§ª Unit Tests') {
            steps {
                echo 'ğŸ§ª Ejecutando pruebas unitarias...'
                sleep 1
                
                script {
                    def testResults = [
                        total: 15,
                        passed: 14,
                        failed: 1,
                        coverage: 85.4
                    ]
                    
                    echo "ğŸ“Š Tests ejecutados: ${testResults.total}"
                    
                    slackSend(
                        channel: env.SLACK_CHANNEL,
                        color: 'warning',
                        message: """
ğŸ§ª *UNIT TESTS COMPLETADOS*
ğŸ“Š Total: ${testResults.total} tests
âœ… Pasados: ${testResults.passed}
âš ï¸ Fallidos: ${testResults.failed}
ğŸ“ˆ Cobertura: ${testResults.coverage}%
                        """,
                        teamDomain: 'vallegrande',
                        tokenCredentialId: 'slack-token'
                    )
                }
            }
        }
        
        stage('ğŸ” SonarCloud Analysis') {
            steps {
                echo 'ğŸ” Ejecutando anÃ¡lisis de SonarCloud...'
                
                slackSend(
                    channel: env.SLACK_CHANNEL,
                    color: '#439FE0',
                    message: "ğŸ” *ANÃLISIS SONARCLOUD* - Iniciando anÃ¡lisis de calidad...",
                    teamDomain: 'vallegrande',
                    tokenCredentialId: 'slack-token'
                )
                
                sleep 1
                
                slackSend(
                    channel: env.SLACK_CHANNEL,
                    color: 'good',
                    message: """
ğŸ“Š *ANÃLISIS SONARCLOUD COMPLETADO*
âœ… Quality Gate: PASSED
ğŸ› Bugs: 2
ğŸ”’ Vulnerabilidades: 0
ğŸ’¨ Code Smells: 8
ğŸ“ˆ Cobertura: 85.4%
ğŸ”— Ver reporte: https://sonarcloud.io/summary/overall?id=${env.SONAR_PROJECT_KEY}
                    """,
                    teamDomain: 'vallegrande',
                    tokenCredentialId: 'slack-token'
                )
            }
        }
        
        stage('ğŸ“¦ Package') {
            steps {
                echo 'ğŸ“¦ Empaquetando aplicaciÃ³n...'
                sleep 1
                echo 'âœ… AplicaciÃ³n empaquetada'
                
                slackSend(
                    channel: env.SLACK_CHANNEL,
                    color: 'good',
                    message: "ğŸ“¦ *EMPAQUETADO COMPLETADO* - Artefacto listo para deployment",
                    teamDomain: 'vallegrande',
                    tokenCredentialId: 'slack-token'
                )
            }
        }
    }
    
    post {
        success {
            script {
                def duration = currentBuild.durationString.replace(' and counting', '')
                
                slackSend(
                    channel: env.SLACK_CHANNEL,
                    color: 'good',
                    message: """
ğŸ‰ *PIPELINE COMPLETADO EXITOSAMENTE* ğŸ‰

ğŸ“ Proyecto: ${env.PROJECT_NAME}
ğŸ”§ Build: #${env.BUILD_NUMBER}
â±ï¸ DuraciÃ³n: ${duration}
ğŸŒŸ Estado: SUCCESS âœ…
ğŸ“Š SonarCloud: https://sonarcloud.io/summary/overall?id=${env.SONAR_PROJECT_KEY}
ğŸ“ˆ Jenkins: ${env.BUILD_URL}

ğŸš€ Â¡Listo para producciÃ³n!
                    """,
                    teamDomain: 'vallegrande',
                    tokenCredentialId: 'slack-token'
                )
            }
        }
        failure {
            script {
                def duration = currentBuild.durationString.replace(' and counting', '')
                
                slackSend(
                    channel: env.SLACK_CHANNEL,
                    color: 'danger',
                    message: """
âŒ *PIPELINE FALLIDO* âŒ

ğŸ“ Proyecto: ${env.PROJECT_NAME}
ğŸ”§ Build: #${env.BUILD_NUMBER}
â±ï¸ DuraciÃ³n: ${duration}
ğŸ’¥ Estado: FAILED
ğŸ” Logs: ${env.BUILD_URL}console

âš ï¸ Â¡Requiere atenciÃ³n inmediata!
                    """,
                    teamDomain: 'vallegrande',
                    tokenCredentialId: 'slack-token'
                )
            }
        }
        always {
            echo 'ğŸ§¹ Limpieza completada'
        }
    }
}