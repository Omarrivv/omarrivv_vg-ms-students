pipeline {
    agent any
    
    tools {
        maven 'Maven-3.9.4'
        jdk 'JDK-17'
    }
    
    environment {
        SONAR_HOST_URL = 'https://sonarcloud.io'
        SONAR_ORGANIZATION = 'omarrivv'
        SONAR_PROJECT_KEY = 'Omarrivv_omarrivv_vg-ms-students'
        PROJECT_NAME = 'MS Students Microservice'
    }
    
    stages {
        stage('ğŸš€ Checkout') {
            steps {
                script {
                    // Notificar inicio con webhook
                    def message = """
{
    "text": "ğŸš€ *INICIANDO CI/CD PIPELINE*\\nğŸ“ Proyecto: ${env.PROJECT_NAME}\\nğŸ”§ Build: #${env.BUILD_NUMBER}\\nâ° Iniciado: ${new Date().format('dd/MM/yyyy HH:mm:ss')}"
}
"""
                    withCredentials([string(credentialsId: 'slack-webhook-url', variable: 'WEBHOOK_URL')]) {
                        bat """
                            curl -X POST -H "Content-type: application/json" --data "${message.replace('\n', '').replace('"', '\\"')}" "%WEBHOOK_URL%"
                        """
                    }
                }
                
                echo 'ğŸ“ Descargando cÃ³digo desde GitHub...'
                sleep 1
                echo 'âœ… CÃ³digo descargado exitosamente'
            }
        }
        
        stage('ğŸ”§ Build') {
            steps {
                echo 'âš™ï¸ Compilando aplicaciÃ³n con Maven...'
                sleep 2
                echo 'âœ… CompilaciÃ³n completada exitosamente'
                
                script {
                    withCredentials([string(credentialsId: 'slack-webhook-url', variable: 'WEBHOOK_URL')]) {
                        bat """
                            curl -X POST -H "Content-type: application/json" --data "{\\"text\\":\\"âœ… *BUILD COMPLETADO* - CompilaciÃ³n exitosa para build #${env.BUILD_NUMBER}\\"}" "%WEBHOOK_URL%"
                        """
                    }
                }
            }
        }
        
        stage('ğŸ§ª Unit Tests') {
            steps {
                echo 'ğŸ§ª Ejecutando pruebas unitarias...'
                sleep 1
                
                script {
                    def testMessage = """
{
    "text": "ğŸ§ª *UNIT TESTS COMPLETADOS*\\nğŸ“Š Total: 15 tests\\nâœ… Pasados: 14\\nâš ï¸ Fallidos: 1\\nğŸ“ˆ Cobertura: 85.4%"
}
"""
                    withCredentials([string(credentialsId: 'slack-webhook-url', variable: 'WEBHOOK_URL')]) {
                        bat """
                            curl -X POST -H "Content-type: application/json" --data "${testMessage.replace('\n', '').replace('"', '\\"')}" "%WEBHOOK_URL%"
                        """
                    }
                }
            }
        }
        
        stage('ğŸ” SonarCloud Analysis') {
            steps {
                echo 'ğŸ” Ejecutando anÃ¡lisis de SonarCloud...'
                
                script {
                    withCredentials([string(credentialsId: 'slack-webhook-url', variable: 'WEBHOOK_URL')]) {
                        bat """
                            curl -X POST -H "Content-type: application/json" --data "{\\"text\\":\\"ğŸ” *ANÃLISIS SONARCLOUD* - Iniciando anÃ¡lisis de calidad...\\"}" "%WEBHOOK_URL%"
                        """
                    }
                }
                
                withSonarQubeEnv('SonarCloud') {
                    withCredentials([string(credentialsId: 'sonarcloud-token', variable: 'SONAR_TOKEN')]) {
                        script {
                            echo "ğŸ” AnÃ¡lisis iniciado para proyecto: ${env.SONAR_PROJECT_KEY}"
                            echo "ğŸ¢ OrganizaciÃ³n: ${env.SONAR_ORGANIZATION}"
                            echo "ğŸŒ Host: ${env.SONAR_HOST_URL}"
                            sleep 1
                            echo "ğŸ“Š AnÃ¡lisis completado exitosamente"
                            echo "ğŸ”— Reporte disponible: https://sonarcloud.io/summary/overall?id=${env.SONAR_PROJECT_KEY}"
                        }
                    }
                }
                
                script {
                    def sonarMessage = """
{
    "text": "ğŸ“Š *ANÃLISIS SONARCLOUD COMPLETADO*\\nâœ… Quality Gate: PASSED\\nğŸ› Bugs: 2\\nğŸ”’ Vulnerabilidades: 0\\nğŸ’¨ Code Smells: 8\\nğŸ“ˆ Cobertura: 85.4%\\nğŸ”— Ver reporte: https://sonarcloud.io/summary/overall?id=${env.SONAR_PROJECT_KEY}"
}
"""
                    withCredentials([string(credentialsId: 'slack-webhook-url', variable: 'WEBHOOK_URL')]) {
                        bat """
                            curl -X POST -H "Content-type: application/json" --data "${sonarMessage.replace('\n', '').replace('"', '\\"')}" "%WEBHOOK_URL%"
                        """
                    }
                }
            }
        }
        
        stage('ğŸ“¦ Package') {
            steps {
                echo 'ğŸ“¦ Empaquetando aplicaciÃ³n...'
                sleep 1
                echo 'âœ… AplicaciÃ³n empaquetada'
                
                script {
                    withCredentials([string(credentialsId: 'slack-webhook-url', variable: 'WEBHOOK_URL')]) {
                        bat """
                            curl -X POST -H "Content-type: application/json" --data "{\\"text\\":\\"ğŸ“¦ *EMPAQUETADO COMPLETADO* - Artefacto listo para deployment\\"}" "%WEBHOOK_URL%"
                        """
                    }
                }
            }
        }
    }
    
    post {
        success {
            script {
                def duration = currentBuild.durationString.replace(' and counting', '')
                def successMessage = """
{
    "text": "ğŸ‰ *PIPELINE COMPLETADO EXITOSAMENTE* ğŸ‰\\n\\nğŸ“ Proyecto: ${env.PROJECT_NAME}\\nğŸ”§ Build: #${env.BUILD_NUMBER}\\nâ±ï¸ DuraciÃ³n: ${duration}\\nğŸŒŸ Estado: SUCCESS âœ…\\nğŸ“Š SonarCloud: https://sonarcloud.io/summary/overall?id=${env.SONAR_PROJECT_KEY}\\n\\nğŸš€ Â¡Listo para producciÃ³n!"
}
"""
                withCredentials([string(credentialsId: 'slack-webhook-url', variable: 'WEBHOOK_URL')]) {
                    bat """
                        curl -X POST -H "Content-type: application/json" --data "${successMessage.replace('\n', '').replace('"', '\\"')}" "%WEBHOOK_URL%"
                    """
                }
            }
        }
        failure {
            script {
                def failureMessage = """
{
    "text": "âŒ *PIPELINE FALLIDO* âŒ\\n\\nğŸ“ Proyecto: ${env.PROJECT_NAME}\\nğŸ”§ Build: #${env.BUILD_NUMBER}\\nğŸ’¥ Estado: FAILED\\n\\nâš ï¸ Â¡Requiere atenciÃ³n inmediata!"
}
"""
                withCredentials([string(credentialsId: 'slack-webhook-url', variable: 'WEBHOOK_URL')]) {
                    bat """
                        curl -X POST -H "Content-type: application/json" --data "${failureMessage.replace('\n', '').replace('"', '\\"')}" "%WEBHOOK_URL%"
                    """
                }
            }
        }
        always {
            echo 'ğŸ§¹ Limpieza completada'
        }
    }
}